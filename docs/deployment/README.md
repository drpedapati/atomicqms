# Deployment Guide

This guide covers deploying AtomicQMS from development to production environments.

## Deployment Overview

AtomicQMS can be deployed in various configurations:

- **Local Development**: Single container on laptop/desktop
- **Lab Server**: Dedicated server for team use
- **Cloud Instance**: AWS, Azure, GCP, or DigitalOcean
- **Multi-Instance**: Federated deployment across sites

## Quick Deployment

### Prerequisites

- Docker 20.10 or later
- Docker Compose 2.0 or later
- 1GB RAM minimum (2GB recommended)
- 10GB disk space minimum

### Basic Deployment

```bash
# Clone repository
git clone https://github.com/atomicqms/atomicqms.git
cd atomicqms

# Start services
docker compose up -d

# Create admin user
docker exec -it atomicqms gitea admin user create \
  --username admin \
  --password 'SecurePassword123!' \
  --email admin@example.com \
  --admin
```

Access at: `http://localhost:3001`

## Production Deployment

For production use, follow these steps:

### 1. Prepare the Environment

```bash
# Create dedicated directory
sudo mkdir -p /opt/atomicqms
cd /opt/atomicqms

# Download docker-compose.yml
curl -O https://raw.githubusercontent.com/atomicqms/atomicqms/main/docker-compose.yml

# Create data directories
mkdir -p data/git data/gitea
```

### 2. Configure Settings

Edit `docker-compose.yml`:

```yaml
version: "3.8"

services:
  atomicqms:
    image: gitea/gitea:latest
    container_name: atomicqms
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__server__DOMAIN=qms.yourcompany.com
      - GITEA__server__ROOT_URL=https://qms.yourcompany.com/
      - GITEA__server__SSH_DOMAIN=qms.yourcompany.com
    restart: always
    volumes:
      - ./data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3001:3000"
      - "222:22"
```

### 3. Set Up Reverse Proxy

Example nginx configuration:

```nginx
server {
    listen 80;
    server_name qms.yourcompany.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name qms.yourcompany.com;

    ssl_certificate /etc/letsencrypt/live/qms.yourcompany.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/qms.yourcompany.com/privkey.pem;

    location / {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4. Configure TLS

Use Let's Encrypt:

```bash
# Install certbot
sudo apt install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --nginx -d qms.yourcompany.com

# Auto-renewal is configured automatically
```

### 5. Start Services

```bash
# Start AtomicQMS
docker compose up -d

# Verify running
docker ps
docker logs atomicqms
```

## Configuration Options

### Environment Variables

Key configuration via environment:

| Variable | Purpose | Example |
|----------|---------|---------|
| `GITEA__server__DOMAIN` | Server domain | `qms.company.com` |
| `GITEA__server__ROOT_URL` | Full URL | `https://qms.company.com/` |
| `GITEA__database__DB_TYPE` | Database type | `sqlite3` or `postgres` |
| `GITEA__security__SECRET_KEY` | Encryption key | (auto-generated) |

### Configuration File

Advanced settings in `data/gitea/conf/app.ini`:

```ini
[server]
APP_NAME = AtomicQMS
DOMAIN = qms.yourcompany.com
ROOT_URL = https://qms.yourcompany.com/
HTTP_PORT = 3000
DISABLE_SSH = false
SSH_PORT = 222

[database]
DB_TYPE = sqlite3
PATH = /data/gitea/gitea.db

[security]
INSTALL_LOCK = true
SECRET_KEY = <auto-generated>

[service]
DISABLE_REGISTRATION = true
REQUIRE_SIGNIN_VIEW = false
ENABLE_NOTIFY_MAIL = true

[mailer]
ENABLED = true
FROM = noreply@yourcompany.com
MAILER_TYPE = smtp
HOST = smtp.yourcompany.com:587
USER = your-smtp-user
PASSWD = your-smtp-password
```

## Backup and Recovery

### Backup Strategy

**What to backup**:
1. Git repositories: `/data/git/repositories/`
2. Database: `/data/gitea/gitea.db`
3. Configuration: `/data/gitea/conf/app.ini`
4. LFS storage: `/data/git/lfs/`

**Automated backup**:

```bash
#!/bin/bash
# backup-atomicqms.sh

BACKUP_DIR=/backups/atomicqms
DATE=$(date +%Y%m%d-%H%M%S)

# Stop container for consistent backup
docker compose stop atomicqms

# Create backup
tar -czf $BACKUP_DIR/atomicqms-$DATE.tar.gz \
  /opt/atomicqms/data

# Restart container
docker compose start atomicqms

# Keep last 30 days
find $BACKUP_DIR -name "atomicqms-*.tar.gz" -mtime +30 -delete
```

Schedule with cron:
```cron
# Daily backup at 2 AM
0 2 * * * /opt/atomicqms/backup-atomicqms.sh
```

### Recovery

```bash
# Stop services
docker compose down

# Restore from backup
tar -xzf /backups/atomicqms/atomicqms-20241026.tar.gz -C /

# Restart services
docker compose up -d
```

## Monitoring

### Health Checks

```bash
# Container status
docker ps

# Application logs
docker logs atomicqms -f

# Resource usage
docker stats atomicqms
```

### Monitoring Metrics

Track these metrics:
- Container uptime
- Disk usage
- Memory usage
- Response time
- Failed login attempts
- Git operation performance

### Alerting

Set up alerts for:
- Container down
- Disk >80% full
- Memory >90% used
- Backup failures
- SSL certificate expiration

## Scaling Considerations

### Single Instance Limits

Typical capacity:
- **Users**: 100-500 concurrent
- **Repositories**: Hundreds to thousands
- **Storage**: Limited by disk space
- **Performance**: Good on modest hardware

### When to Scale

Consider scaling when:
- Response time degrades
- Storage approaching limits
- User base exceeds 500
- Need high availability
- Geographic distribution required

### Scaling Options

1. **Vertical**: Larger server (more CPU/RAM/disk)
2. **Horizontal**: Multiple instances with shared storage
3. **PostgreSQL**: Replace SQLite for better concurrency
4. **Load Balancer**: Distribute traffic across instances

See [Scaling Guide](./scaling.md) for details.

## Security Hardening

### Access Control

- Disable public registration
- Enforce strong passwords
- Enable 2FA for admins
- Use SSH keys for Git access
- Limit API token permissions

### Network Security

- Use TLS for all connections
- Restrict SSH to known IPs
- Use firewall rules
- Regular security updates

### Compliance

- Enable audit logging
- Configure log retention
- Regular backup verification
- Document access procedures
- Review user permissions quarterly

## Troubleshooting

### Common Issues

**Container won't start**:
```bash
# Check logs
docker logs atomicqms

# Common causes:
# - Port conflicts (3001 already in use)
# - Permission issues on volumes
# - Corrupted configuration
```

**Can't access web interface**:
```bash
# Verify container running
docker ps | grep atomicqms

# Check port mapping
docker port atomicqms

# Test connectivity
curl http://localhost:3001
```

**Git operations fail**:
```bash
# Check Git protocol
git ls-remote http://localhost:3001/qms/sops.git

# Verify credentials
git config --global credential.helper store

# Check logs
docker logs atomicqms | grep -i git
```

## Next Steps

Explore deployment topics:

- [Docker Compose Details](./docker-compose.md)
- [Configuration Reference](./configuration.md)
- [Scaling Strategies](./scaling.md)
